<!DOCTYPE html>
<html lang="zh-TW">
<head>
	<meta name="viewport" content="user-scalable=0">
	<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js'></script>
	
	<!--引用SweetAlert2-->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/6.10.3/sweetalert2.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/6.10.3/sweetalert2.js" type="text/javascript"></script>
	<script src="https://code.jquery.com/jquery-1.9.1.js"></script>
	<script src="https://d.line-scdn.net/liff/1.0/sdk.js"></script>
	
	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/6.4.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-database.js"></script>

	<script>
	  // Your web app's Firebase configuration
	  var firebaseConfig = {
		apiKey: "AIzaSyAReWVyHupYjqvDOVw7y4iQ-4raNrccASA",
		authDomain: "racing-86f50.firebaseapp.com",
		databaseURL: "https://racing-86f50.firebaseio.com",
		projectId: "racing-86f50",
		storageBucket: "racing-86f50.appspot.com",
		messagingSenderId: "73612947849",
		appId: "1:73612947849:web:ca1d6ae60943949f"
	  };
	  // Initialize Firebase
	  firebase.initializeApp(firebaseConfig);
	</script>
	
	<style>
	.hitLap {
		width:100%;
		height:100px;
		font-size: 50px;
		font-family:Microsoft JhengHei;	
	}
	.switch_group {
		width: 30%;
		text-align:center;
		font-size: 50px;
		font-family:Microsoft JhengHei;	
	}
	.switch_mode {
		width: 70%;
		text-align:center;
		font-size: 50px;
		font-family:Microsoft JhengHei;	
	}
	.default {
		font-size: 50px;
		font-family:Microsoft JhengHei;	
	}
	.comment {
		font-size: 42px;
		font-family:Microsoft JhengHei;	
	}
	.table {
		font-size: 50px;
		text-align:center;
		font-family:Microsoft JhengHei;	
	}
	.my-swal{
		zoom: 1.6 !important;
		width:80% !important;
	}
	
	</style>
</head>

<body onload="start()">
	<select name="groupName" id="groupID" class ="switch_group" onchange="setGroup()">
	<option value="groupA">第一組</option>
	<option value="groupB">第二組</option>
	
	<input type="button" id="startBtn" class ="switch_mode" onclick="checkPassword()" value="切換(開始/結束/重置)模式"></input>

	<div id="showStatus" class ="default"></div>
	<div id="showNowTime" class ="default"></div>
	<div id="showStartTime" class ="default"></div>
	<div id="showFinishTime" class ="default"></div>
	<div id="runTimeAll" class ="default"></div>
	<hr>
	<div id="showTable" class ="table">Loading...</div>
	<hr>
	<div class ="comment">使用注意事項：</div>
	<div class ="comment">１、避免數據交互干擾，負責的選手請勿重複。</div>
	<div class ="comment">２、於重置模式，所有數據將歸零且毫不保留。</div>
	<div class ="comment">３、若需反覆點選同位選手，請間隔１秒以上。</div>
	<div class ="comment">４、競賽中點選圈數按鈕，將減１並重新秒數。</div>
	<div class ="comment">５、競賽中圈數減為０代表完賽，將停止成績。</div>
	<div class ="comment">６、請確認選手通過記圈線的同時，按下按鈕。</div>
	<div class ="comment">７、為避免誤按到切換模式，有設計密碼保護。</div>
	<div class ="comment">８、若反覆跳出錯誤視窗，請將網頁重啟即可。</div>
	<div class ="comment">９、設計成績欄位顯示的上限為５９分５９秒。</div>
	<div class ="comment">Ａ、設計每圈秒數欄位顯示的上限為９９９秒。</div>
	<div class ="comment">Ｂ、時間資訊設計每１００毫秒自動刷新一次。</div>
	<div class ="comment">Ｃ、選手的競賽資訊，每３秒會自動更新同步。</div>
	
	<script>
	const gResetTime = new Date(2019, 1, 1, 00, 00, 00);
	var gStartTime = new Date(2019, 1, 1, 00, 00, 00);
	var gFinishTime = new Date(2019, 1, 1, 00, 00, 00);	
	var gLapArray = new Array();
	var gLapTimeArray = new Array();
	var gRunTimeArray = new Array();
	var gLapSecArray = new Array();
	var gLength;
	var gSpreadsheetsLink;
	var gGroupName;
	var gGroupStatus;
	var gNumberOfLaps;
	var db = firebase.database();
	var gSetInterval_showTime, gSetInterval_loadPage;
	
	function start() {
		liff.init(function (data) {
			swal({
				title: data.context.userId + '，請輸入密碼進入記圈模式',
				input: 'text',
				html: '正確輸入密碼將進入記圈模式，取消即為觀戰模式！',
				customClass: 'my-swal',
				showCancelButton: true,
				confirmButtonText: '　確認　', 
				cancelButtonText: '　取消　',
				inputValidator: function(value) {
					return new Promise(function(resolve, reject) {
						if (value == 168) {
							resolve();
						} else {
							reject('請輸入正確密碼');
						}
					});
				}
			}).then(function(result) {
				swal({
					type: 'success',
					title: data.context.userId + '，您已進入記圈模式！',
					confirmButtonText: '　確認　',
					customClass: 'my-swal',
				});
			});
		});
	}
	
	function setGroup() {
		document.all("showTable").innerHTML = "";
		clearTimeout(gSetInterval_showTime);
		clearTimeout(gSetInterval_loadPage);
		gLength = 0;
		gLapArray.length = 0;
		gLapTimeArray.length = 0;
		gRunTimeArray.length = 0;
		gRunTimeArray.length = 0;
		
		gGroupName = document.getElementById("groupID").value;
		
		db.ref("/timer/"+gGroupName+"/startTime").on('value', function (snapshot) {
			gStartTime.setTime(snapshot.val());
		});
		db.ref("/timer/"+gGroupName+"/finishTime").on('value', function (snapshot) {
			gFinishTime.setTime(snapshot.val());
		});
		db.ref("/timer/"+gGroupName+"/status").on('value', function (snapshot) {
			gGroupStatus = snapshot.val();
			if (gGroupStatus == "開始")			document.getElementById("showStatus").innerHTML = '目前狀態: 已重置';
			else if (gGroupStatus == "結束")	document.getElementById("showStatus").innerHTML = '目前狀態: 競賽中';
			else if (gGroupStatus == "重置")	document.getElementById("showStatus").innerHTML = '目前狀態: 已結束';	
		});

		db.ref("/timer/setting/spreadsheetLink").once('value', function (snapshot) {
			gSpreadsheetsLink = snapshot.val();
		});
		db.ref("/timer/setting/numberOfLaps").once('value', function (snapshot) {
			gNumberOfLaps = snapshot.val();
		});
		db.ref("/timer/"+gGroupName+"/queryRunner").on('value', function (snapshot) {
			gQuery = snapshot.val();
		});
		
		if (gGroupStatus == "開始" && 
			((gStartTime.getTime() != gResetTime.getTime()) || (gFinishTime.getTime() != gResetTime.getTime()))) {
			errorMessage("S01");
			setGroup();
			return;		
		}
		
		if (gGroupStatus == "結束" && 
			((gStartTime.getTime() == gFinishTime.getTime()) || (gFinishTime.getTime() != gResetTime.getTime()))) {
			errorMessage("S02");
			setGroup();
			return;		
		}
		
		if (gGroupStatus == "重置" && 
			((gStartTime.getTime() == gFinishTime.getTime()) || (gFinishTime.getTime() == gResetTime.getTime()))) {
			errorMessage("S03");
			setGroup();
			return;		
		}
		
		gSetInterval_loadPage = setInterval('LoadPages()',3000);
		gSetInterval_showTime = setInterval('showTime()',100);
	}
	
	function LoadPages() {
		$.getJSON(gSpreadsheetsLink+gQuery, function(json){
			var vTable = "";
			vTable = vTable + "<table border=1 width=100%>";
			vTable = vTable + "<tr class='divTableHeading'>";
			vTable = vTable + "<td class='divTableHead'>";
			vTable = vTable + "姓名";
			vTable = vTable + "</td>";
			vTable = vTable + "<td class='divTableHead'>";
			vTable = vTable + "成績";
			vTable = vTable + "</td>";
			vTable = vTable + "<td class='divTableHead'>";
			vTable = vTable + "序號";
			vTable = vTable + "</td>";
			vTable = vTable + "<td class='divTableHead' width=25%>";
			vTable = vTable + "圈數";
			vTable = vTable + "</td>";
			vTable = vTable + "<td class='divTableHead'>";
			vTable = vTable + "秒數";
			vTable = vTable + "</td>";
			vTable = vTable + "</tr>";
			
			var e = json.feed.entry,
			//html = "",
			entry, i, 序號, 姓名, 成績, 圈數, 秒數 ;
			gLength = e.length;

			for (i = 0; i < gLength; i++) {
				entry = e[i];
				序號 = entry.gsx$序號.$t;
				姓名 = entry.gsx$姓名.$t;
				圈數 = entry.gsx$圈數.$t;
				成績 = entry.gsx$成績.$t;
				
				/* Known Issue */
				if ((gGroupName == "groupA" && 序號.startsWith("B")) || (gGroupName == "groupB" && 序號.startsWith("A")))
				{
					errorMessage("L01"); 
					return;
				}
				
				vTable = vTable + "<tr>";
				vTable = vTable + "<td>";
				vTable = vTable + 姓名;
				vTable = vTable + "</td>";
				/* 成績 */		
				vTable = vTable + "<td>";
				if (圈數 == 0) {
					vTable = vTable + "<label id='rumtime"+i+"' text='"+成績+"'>"+成績+" </>";
				} else if (gLapArray[i] == 0) {
					/* 於 Lap = 0 時, 會將 gLapTimeArray 改存成完成時間的字串 */
					vTable = vTable + "<label id='rumtime"+i+"' text='"+成績+"'>"+gLapTimeArray[i]+" </>";
				} else {
					vTable = vTable + "<label id='rumtime"+i+"' text='"+成績+"'>"+gRunTimeArray[i]+" </>";
				}
				vTable = vTable + "</td>";
				/* 序號 */
				vTable = vTable + "<td>";
				vTable = vTable + "<label id='item"+i+"' text='"+序號+"'>"+序號+" </>";
				vTable = vTable + "</td>";
				/* 圈數 */
				vTable = vTable + "<td>";
				if (圈數 == 0) {
					vTable = vTable + "<input type='button' id='lap"+i+"' class='hitLap' value='"+圈數+"'> </input>";
				} else if ((gLapTimeArray[i] > 成績) || (gLapArray[i] == 0)) {
					vTable = vTable + "<input type='button' id='lap"+i+"' class='hitLap' value='"+gLapArray[i]+"'> </input>";
				} else {
					vTable = vTable + "<input type='button' id='lap"+i+"' class='hitLap' value='"+圈數+"'> </input>";
				}
				vTable = vTable + "</td>";
				/* 區間秒數 */
				vTable = vTable + "<td>";
				vTable = vTable + "<label id='laptime"+i+"' text='"+秒數+"'>"+gLapSecArray[i]+"</>";
				vTable = vTable + "</td>";
				vTable = vTable + "</tr>";
				var vDiv = document.all("showTable").innerHTML = vTable;
				if (!(gLapTimeArray[i] > 成績)) {
					//gLapArray[i] = 圈數;
					gLapTimeArray[i] = 成績;
				}
			}
			
			//$("#test").html(html);
			$('.hitLap').on('click',function(){
				$(this).attr('disabled',true);
				var lap = $(this).val().replace(/\s+/g, "");
				var id = $(this).attr('id').replace("lap", "");
				if (gFinishTime.getTime() == gResetTime.getTime()) {
					if (gStartTime.getTime() != gResetTime.getTime() && lap != 0) {
						var nowTime = new Date();
						var runTime = new Date();
						$(this).val(lap - 1);
						if ($(this).val() == 0) {
							runTime.setTime(nowTime.getTime() - gStartTime.getTime());
							gLapTimeArray[id] = timeString('runTimeAll', runTime);
							document.getElementById('rumtime'+id).innerHTML = gLapTimeArray[id];
						} else {
							gLapTimeArray[id] = nowTime.getTime();
						}
						gLapArray[id] = $(this).val();
						
						data = [[gLapArray[id], gLapTimeArray[id]]];
						parameter = {
							url: "https://docs.google.com/spreadsheets/d/1L0JDjocOddl2LaRCEwi5MnqN6q-XCflOcl8UYR-kims/edit#gid=0",
							name: "20190901",
							method: "timer",
							uuid: document.getElementById('item'+id).innerHTML.replace(/\s+/g, ""),
							data: data.toString(),
							row: data.length,
							column: data[0].length,
						};
						$.post("https://script.google.com/macros/s/AKfycbyw_TkcMZAqnpuy0BXmpdfUgeHo7pMBHUgBiHp_gQq1KtG_aBU/exec", parameter);
					}
				}
			});
		});
	}

	function errorMessage(errorCode) {
		swal({
			type: 'error',
			title: '發現錯誤 ('+errorCode+')', 
			text: '錯誤已迴避，但如果仍反覆出現，請將網頁重啟！',
			customClass: 'my-swal',
			confirmButtonText: '　確認　',
		});
	}
	
	function paddingLeft(str,lenght){
		if(str.length >= lenght)
			return str;
		else
			return paddingLeft("0" +str, lenght);
	}

	function timeString(id, time) {
		var hh = time.getHours();
		var mm = time.getMinutes();
		var ss = time.getSeconds();
		var ms = Math.floor((time.getMilliseconds())/10);
		var lapSeconds = (mm * 60 + ss)%999;
		hh = hh < 10 ? ('0' + hh) : hh;
		mm = mm < 10 ? ('0' + mm) : mm;
		ss = ss < 10 ? ('0' + ss) : ss;
		ms = ms < 10 ? ('0' + ms) : ms;
		if (id == 'showStartTime') {
			document.getElementById(id).innerHTML = '起跑時間: '+hh+':'+mm+':'+ss+'.'+ms;
		} else if (id == 'showFinishTime') {
			document.getElementById(id).innerHTML = '結束時間: '+hh+':'+mm+':'+ss+'.'+ms;
		} else if (id == 'showNowTime') {
			document.getElementById(id).innerHTML = '現在時間: '+hh+':'+mm+':'+ss+'.'+ms;
		} else if (id.startsWith("laptime")) {
			document.getElementById(id).innerHTML = paddingLeft(lapSeconds+'s', 4);
			return paddingLeft(lapSeconds+'s', 4);
		}
		
		return (mm+':'+ss+'.'+ms);
	}

	function switchStatus() {
		//alert("test1");
		swal({
			type: 'success',
			title: '已切換模式', 
			customClass: 'my-swal',
			confirmButtonText: '　確認　',
		});
		gGroupName = document.getElementById("groupID").value;

		if (gGroupStatus == "開始") {
			gStartTime = new Date();
			db.ref("/timer/"+gGroupName+"/startTime").set(gStartTime.getTime());
			db.ref("/timer/"+gGroupName+"/status").set("結束");
		} else if (gGroupStatus == "結束") {
			gFinishTime = new Date();
			db.ref("/timer/"+gGroupName+"/finishTime").set(gFinishTime.getTime());
			db.ref("/timer/"+gGroupName+"/status").set("重置");
		} else {
			gStartTime = gResetTime;
			gFinishTime = gResetTime;
			db.ref("/timer/"+gGroupName+"/startTime").set(gStartTime.getTime());
			db.ref("/timer/"+gGroupName+"/finishTime").set(gFinishTime.getTime());
			db.ref("/timer/"+gGroupName+"/status").set("開始");
		}
		//alert("test2");
	}
	
	
	function checkPassword() {

		swal({
			title: '請先輸入密碼',
			input: 'text',
			html: '( ' + document.getElementById("showStatus").innerHTML + ' )',
			customClass: 'my-swal',
			showCancelButton: true,
			confirmButtonText: '　確認　', 
			cancelButtonText: '　取消　',
			inputValidator: function(value) {
				return new Promise(function(resolve, reject) {
					if (value == 9527) {
						resolve();
					} else {
						reject('請輸入正確密碼');
					}
				});
			}
		}).then(function(result) {
			swal({
				type: 'question',
				title: '是否確認切換模式？',
				showCancelButton: true,
				confirmButtonText: '　確認　',
				cancelButtonText: '　取消　',
				customClass: 'my-swal',
			}).then(function() {
				switchStatus();
			});
		});

	}

	function showTime(){
		var nowTime = new Date();
		var runTime = new Date();
		var lapTime = new Date();

		timeString('showNowTime', nowTime);
		timeString('showFinishTime', gFinishTime);

		if (gStartTime.getTime() == gResetTime.getTime()) {
		/* 目前狀態: 已重置 */
			timeString('showStartTime', gStartTime);
			var sTime = timeString('runTimeAll', gResetTime);
			for ( var i = 0; i < gLength; i++) {
				document.getElementById('rumtime'+i).innerHTML = sTime;
				gRunTimeArray[i] = sTime;
				document.getElementById('laptime'+i).innerHTML = "000s";
				gLapSecArray[i] = "000s";
				gLapArray[i] = gNumberOfLaps;
				if ($("#lap"+i).val() != gNumberOfLaps) {
					$("#lap"+i).val(gNumberOfLaps);
					
					data = [[$("#lap"+i).val(), 0]];
					parameter = {
						url: "https://docs.google.com/spreadsheets/d/1L0JDjocOddl2LaRCEwi5MnqN6q-XCflOcl8UYR-kims/edit#gid=0",
						name: "20190901",
						method: "timer",
						uuid: document.getElementById('item'+i).innerHTML.replace(/\s+/g, ""),
						data: data.toString(),
						row: data.length,
						column: data[0].length,
					};
					$.post("https://script.google.com/macros/s/AKfycbyw_TkcMZAqnpuy0BXmpdfUgeHo7pMBHUgBiHp_gQq1KtG_aBU/exec", parameter); 
				}
			}
		} else if (gFinishTime.getTime() != gResetTime.getTime()) {
			/* 目前狀態: 已結束 */
			timeString('showStartTime', gStartTime);
			for ( var i = 0; i < gLength; i++) {
				if ($("#lap"+i).val() != 0) {
					document.getElementById('rumtime'+i).innerHTML = "59:59.99"; 
					gRunTimeArray[i] = "59:59.99"
				}
				document.getElementById('laptime'+i).innerHTML = "000s";
				gLapSecArray[i] = "000s";
			}
		} else {
			/* 目前狀態: 競賽中 */
			timeString('showStartTime', gStartTime);
			runTime.setTime(nowTime.getTime() - gStartTime.getTime());
			var sTime = timeString('runTimeAll', runTime);
			for ( var i = 0; i < gLength; i++) {
				if ($("#lap"+i).val() != 0) {	
					document.getElementById('rumtime'+i).innerHTML = sTime; 
					gRunTimeArray[i] = sTime;

					if ($("#lap"+i).val() == gNumberOfLaps) {
						lapTime.setTime(nowTime.getTime() - gStartTime.getTime());
					} else {
						lapTime.setTime(nowTime.getTime() - gLapTimeArray[i]);
					}
					gLapSecArray[i] = timeString('laptime'+i, lapTime);
				} else {
					document.getElementById('laptime'+i).innerHTML = "000s";
					gLapSecArray[i] = "000s";
				}
			}
		}
	}

	</script>

</body>
</html>
