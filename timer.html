<!DOCTYPE html>
<html lang="zh-TW">
<head>
	<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js'></script>
	
	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/6.4.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-database.js"></script>

	<script>
	  // Your web app's Firebase configuration
	  var firebaseConfig = {
		apiKey: "AIzaSyAReWVyHupYjqvDOVw7y4iQ-4raNrccASA",
		authDomain: "racing-86f50.firebaseapp.com",
		databaseURL: "https://racing-86f50.firebaseio.com",
		projectId: "racing-86f50",
		storageBucket: "racing-86f50.appspot.com",
		messagingSenderId: "73612947849",
		appId: "1:73612947849:web:ca1d6ae60943949f"
	  };
	  // Initialize Firebase
	  firebase.initializeApp(firebaseConfig);
	</script>
	
	<style>
	.hitLap {
		width:100%;
		font-size: 20px;
		font-family:Microsoft JhengHei;	
	}
	.switch {
		width: 50%;
		text-align:center;
		font-size: 20px;
		font-family:Microsoft JhengHei;	
	}	
	.default {
		font-size: 20px;
		font-family:Microsoft JhengHei;	
	}
	.table {
		font-size: 20px;
		text-align:center;
		font-family:Microsoft JhengHei;	
	}
	
	</style>
</head>

<body onload="start()">
	<select name="groupName" id="groupID" class ="switch" onchange="setGroup()">
	<option value="groupA">第一組</option>
	<option value="groupB">第二組</option>
	<option value="groupC">第三組</option>
	
	<input type="button" id="startBtn" class ="switch" onclick="switchStatus()" value="切換模式"></input>

	<div id="showStatus" class ="default"></div>
	<div id="showNowTime" class ="default"></div>
	<div id="showStartTime" class ="default"></div>
	<div id="showFinishTime" class ="default"></div>
	<div id="runTimeAll" class ="default"></div>
	<div id="showTable" class ="table">Loading...</div>

	<script>
	var gLapTimeArray = new Array();
	var gStartTime = new Date(2019, 1, 1, 00, 00, 00);
	var gResetTime = new Date(2019, 1, 1, 00, 00, 00);
	var gFinishTime = new Date(2019, 1, 1, 00, 00, 00);
	var gLength;
	var gGroupName;
	var gGroupStatus;
	var db = firebase.database();
	
	function start() {
		setGroup();
		ShowTime();
	}

	function setGroup() {
		gGroupName = document.getElementById("groupID").value;

		db.ref("/timer/"+gGroupName+"/startTime").on('value', function (snapshot) {
			gStartTime.setTime(snapshot.val());
		});
		db.ref("/timer/"+gGroupName+"/finishTime").on('value', function (snapshot) {
			gFinishTime.setTime(snapshot.val());
		});
		db.ref("/timer/"+gGroupName+"/status").on('value', function (snapshot) {
			gGroupStatus = snapshot.val();
			//$("#startBtn").val(snapshot.val());
			if (gGroupStatus == "開始")			document.getElementById("showStatus").innerHTML = '目前狀態: 已重置';
			else if (gGroupStatus == "結束")	document.getElementById("showStatus").innerHTML = '目前狀態: 競賽中';
			else if (gGroupStatus == "重置")	document.getElementById("showStatus").innerHTML = '目前狀態: 已結束';
			
		});
		db.ref("/timer/"+gGroupName+"/queryRunner").on('value', function (snapshot) {
			gQuery = snapshot.val();
			LoadPages();
		});

	}

	function LoadPages() {
		$.getJSON("https://spreadsheets.google.com/feeds/list/1L0JDjocOddl2LaRCEwi5MnqN6q-XCflOcl8UYR-kims/7/public/values?alt=json-in-script&callback=?"+gQuery, 
		function(json){
			var vTable = "";
			vTable = vTable + "<table border=1 width=100%>";
			vTable = vTable + "<tr class='divTableHeading'>";
			vTable = vTable + "<td class='divTableHead'>";
			vTable = vTable + "姓名";
			vTable = vTable + "</td>";
			vTable = vTable + "<td class='divTableHead'>";
			vTable = vTable + "成績";
			vTable = vTable + "</td>";
			vTable = vTable + "<td class='divTableHead'>";
			vTable = vTable + "序號";
			vTable = vTable + "</td>";
			vTable = vTable + "<td class='divTableHead'>";
			vTable = vTable + "圈數";
			vTable = vTable + "</td>";
			vTable = vTable + "<td class='divTableHead'>";
			vTable = vTable + "秒數";
			vTable = vTable + "</td>";
			vTable = vTable + "</tr>";
			
			var e = json.feed.entry,
			//html = "",
			entry, i, 序號, 姓名, 成績, 圈數 ;
			gLength = e.length;

			for (i = 0; i < gLength; i++) {
				entry = e[i];
				序號 = entry.gsx$序號.$t;
				姓名 = entry.gsx$姓名.$t;
				圈數 = entry.gsx$圈數.$t;
				成績 = entry.gsx$成績.$t;
				vTable = vTable + "<tr>";
				vTable = vTable + "<td>";
				vTable = vTable + 姓名;
				vTable = vTable + "</td>";
				/* 成績 */		
				vTable = vTable + "<td>";
				vTable = vTable + "<label id='rumtime"+i+ "'/>";
				vTable = vTable + "</td>";
				/* 序號 */
				vTable = vTable + "<td>";
				vTable = vTable + "<label id='item"+i+"' text='"+序號+"'>"+序號+" </>";
				vTable = vTable + "</td>";
				/* 圈數 */
				vTable = vTable + "<td>";
				vTable = vTable + "<input type='button' id='lap"+i+"' class='hitLap' value='"+圈數+"'> </input>";
				vTable = vTable + "</td>";
				/* 區間秒數 */
				vTable = vTable + "<td>";
				vTable = vTable + "<label id='laptime"+i+ "'/>";
				vTable = vTable + "</td>";
				vTable = vTable + "</tr>";
				var vDiv = document.all("showTable");
				vDiv.innerHTML = vTable;
				gLapTimeArray.push(gStartTime);
			}
			
			//$("#test").html(html);
			$('.hitLap').on('click',function(){
				var lap = $(this).val().replace(/\s+/g, "");
				var id = $(this).attr('id').replace("lap", "");
				if (gStartTime.getTime() != gResetTime.getTime() && lap != 0) {
					$(this).val(lap -1);
					var nowTime = new Date();
					gLapTimeArray[id] = nowTime.getTime();
					
					data = [[$(this).val(), gLapTimeArray[id]]];
					parameter = {
						url: "https://docs.google.com/spreadsheets/d/1L0JDjocOddl2LaRCEwi5MnqN6q-XCflOcl8UYR-kims/edit#gid=0",
						name: "20190803",
						method: "timer",
						uuid: document.getElementById('item'+id).innerHTML.replace(/\s+/g, ""),
						data: data.toString(),
						row: data.length,
						column: data[0].length,
					};
					$.post("https://script.google.com/macros/s/AKfycbyw_TkcMZAqnpuy0BXmpdfUgeHo7pMBHUgBiHp_gQq1KtG_aBU/exec", parameter);
				}
			});
		});
	}

	function timeString(id, time) {
		var hh = time.getHours();
		var mm = time.getMinutes();
		var ss = time.getSeconds();
		var ms = Math.floor((time.getMilliseconds()+1)/10);
		var lapSeconds = mm * 60 + ss;
		hh = hh < 10 ? ('0' + hh) : hh;
		mm = mm < 10 ? ('0' + mm) : mm;
		ss = ss < 10 ? ('0' + ss) : ss;
		ms = ms < 10 ? ('0' + ms) : ms;
		if (id == 'showStartTime') {
			document.getElementById(id).innerHTML = '起跑時間: '+hh+':'+mm+':'+ss+'.'+ms;
		} else if (id == 'showFinishTime') {
			document.getElementById(id).innerHTML = '結束時間: '+hh+':'+mm+':'+ss+'.'+ms;
		} else if (id == 'showNowTime') {
			document.getElementById(id).innerHTML = '現在時間: '+hh+':'+mm+':'+ss+'.'+ms;
		} else if (id.startsWith("laptime")) {
			document.getElementById(id).innerHTML = lapSeconds+'s';	
		}
		
		return (mm+':'+ss+'.'+ms);
	}


	function switchStatus () {
		gGroupName = document.getElementById("groupID").value;

		if (gGroupStatus == "開始") {
			gStartTime = new Date();
			db.ref("/timer/"+gGroupName+"/startTime").set(gStartTime.getTime());
			db.ref("/timer/"+gGroupName+"/status").set("結束");
		} else if (gGroupStatus == "結束") {
			gFinishTime = new Date();
			db.ref("/timer/"+gGroupName+"/finishTime").set(gFinishTime.getTime());
			db.ref("/timer/"+gGroupName+"/status").set("重置");
		} else {
			gStartTime = gResetTime;
			gFinishTime = gResetTime;
			db.ref("/timer/"+gGroupName+"/startTime").set(gStartTime.getTime());
			db.ref("/timer/"+gGroupName+"/finishTime").set(gFinishTime.getTime());
			db.ref("/timer/"+gGroupName+"/status").set("開始");
		}
	}

	function ShowTime(){
		var nowTime = new Date();
		var runTime = new Date();
		var lapTime = new Date();

		timeString('showNowTime', nowTime);
		timeString('showFinishTime', gFinishTime);

		if (gStartTime.getTime() == gResetTime.getTime()) {
			timeString('showStartTime', gStartTime);
			var sTime = timeString('runTimeAll', gResetTime);
			for ( var i = 0; i < gLength; i++) {
				document.getElementById('rumtime'+i).innerHTML = sTime; 
				document.getElementById('laptime'+i).innerHTML = "0s";
				if ($("#lap"+i).val() != 13) {
					$("#lap"+i).val(13);
					
					
					/* 
					data = [[$("#lap"+i).val(), 0]];
					parameter = {
						url: "https://docs.google.com/spreadsheets/d/1L0JDjocOddl2LaRCEwi5MnqN6q-XCflOcl8UYR-kims/edit#gid=0",
						name: "20190803",
						method: "timer",
						uuid: document.getElementById('item'+i).innerHTML.replace(/\s+/g, ""),
						data: data.toString(),
						row: data.length,
						column: data[0].length,
					};
					$.post("https://script.google.com/macros/s/AKfycbyw_TkcMZAqnpuy0BXmpdfUgeHo7pMBHUgBiHp_gQq1KtG_aBU/exec", parameter); 
					*/
				}
			}	
		} else {
			timeString('showStartTime', gStartTime);
			runTime.setTime(nowTime.getTime() - gStartTime.getTime());
			var sTime = timeString('runTimeAll', runTime);
			for ( var i = 0; i < gLength; i++) {
				if ($("#lap"+i).val() != 0) {	
					document.getElementById('rumtime'+i).innerHTML = sTime; 

					if ($("#lap"+i).val() == 13) {
						lapTime.setTime(nowTime.getTime() - gStartTime.getTime());
					} else {
						lapTime.setTime(nowTime.getTime() - gLapTimeArray[i]);
					}
					timeString('laptime'+i, lapTime);
				}
			}
		}

		setTimeout('ShowTime()',100);
	}

	</script>

</body>
</html>
